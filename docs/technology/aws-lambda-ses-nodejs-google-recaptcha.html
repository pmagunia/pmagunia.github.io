<!DOCTYPE HTML> <html lang="en"><head> <meta charset="utf-8"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" href="/assets/css/fontello/css/pmagunia.min.css"> <link rel="stylesheet" href="/assets/css/rouge.min.css"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="robots" content="index, follow"> <link rel="canonical" href="https://pmagunia.com/technology/aws-lambda-ses-nodejs-google-recaptcha.html"> <title>Creating an AWS Lambda App That Sends an SES Email Upon Successful Google Recaptcha in NodeJS v20 | On Things | Parag's Web</title> <meta name="description" content="Node 16 was no longer going to be supported so I wanted to update my AWS Lambda app that validates Google Recaptcha via REST to..."> <meta name="author" content="Parag Magunia"> <script async src="/assets/js/main.min.js"></script> </head> <body> <div id="headerToggle"><a href="#" class="toggle" onclick="menuToggle()" title="Open Menu"><span class="icon icon-menu"></span></a></div><div id="header"> <div class="top"><div id="logo"> <a href="https://pmagunia.com/" id="home-link"> <span class="image avatar48"><img loading="lazy" src="/assets/images/pmagunia_favicon.webp" height="55.33px" width="38.67px" alt="Avatar of Parag Magunia"></span> <h2 id="title">On Things</h2> <p>Parag's Web</p> </a> </div> <nav id="nav"> <ul> <li class="home"> <a href="https://pmagunia.com/" id="home-link-id"><span class="icon icon-home">Home</span></a> </li><li class="contact"> <a href="https://pmagunia.com/contact.html" id="contact-link-id"><span class="icon icon-mail">Contact</span></a> </li><li class="real-analysis"> <a href="https://pmagunia.com/real-analysis.html" id="real-analysis-link-id"><span class="icon icon-infinity">Real Analysis</span></a> </li><li class="statistics"> <a href="https://pmagunia.com/statistics.html" id="statistics-link-id"><span class="icon icon-chart-bar">Statistics</span></a> </li><li class="technology"> <a href="https://pmagunia.com/technology.html" id="technology-link-id"><span class="icon icon-desktop">Technology</span></a> </li><li class="arithmetic"> <a href="https://pmagunia.com/arithmetic.html" id="arithmetic-link-id"><span class="icon icon-chart-pie">Arithmetic</span></a> </li><li class="datasets"> <a href="https://pmagunia.com/datasets.html" id="datasets-link-id"><span class="icon icon-database">Datasets</span></a> </li><li class="spirituality"> <a href="https://pmagunia.com/spirituality.html" id="spirituality-link-id"><span class="icon icon-leaf">Spirituality</span></a> </li></ul> </nav> </div> <div class="bottom"><ul class="icons"> <li><a href="https://drupal.org/u/pmagunia" class="icon icon-drupal" title="Drupal"><span class="label">Drupal</span></a></li> <li><a href="https://twitter.com/pmagunia" class="icon icon-twitter" title="Twitter"><span class="label">Twitter</span></a></li> <li><a href="https://www.linkedin.com/in/pmagunia" class="icon icon-linkedin-squared" title="LinkedIn"><span class="label">LinkedIn</span></a></li> <li><a href="https://github.com/pmagunia" class="icon icon-github-circled" title="Github"><span class="label">GitHub</span></a></li> <li><a href="https://www.upwork.com/freelancers/~015b1032d2938319a8?viewMode=1" class="icon upwork" title="Upwork">$<span class="label">Upwork</span></a></li> <li><a href="https://soundcloud.com/pmagunia" class="icon icon-soundcloud" title="SoundCloud"><span class="label">SoundCloud</span></a></li> <li><a href="https://stackoverflow.com/users/312471/pmagunia" class="icon icon-stackoverflow" title="StackOverflow"><span class="label">StackOverflow</span></a></li> </ul> </div> </div> <div id="main"> <article class="shade-two"> <div class="container"> <br> <header> <h1>Creating an AWS Lambda App That Sends an SES Email Upon Successful Google Recaptcha in NodeJS v20</h1> </header> <p>May 22, 2024</p><p>Node 16 was no longer going to be supported so I wanted to update my AWS Lambda app that validates Google Recaptcha via REST to the latest version (NodeJS v20). You may have to change some of the things around below, but it is working for me (proof is this websites Contact form; feel free to say Hello if this worked for you). I also posted the solution on StackOverflow:</p> <p><a href="https://stackoverflow.com/questions/78520621/how-to-send-an-aws-ses-email-in-lambda-with-aws-sdk-v3-using-the-latest-version">https://stackoverflow.com/questions/78520621/how-to-send-an-aws-ses-email-in-lambda-with-aws-sdk-v3-using-the-latest-version</a></p> <p>You will want to add your own Recaptcha secret and also adjust the AWS Region. The event variables must also be customized based on the REST values sent via your AWS API Gateway (not covered here.) This took me awhile to wrap my horns around. I’m not a Node person by default so I had to learn many of the paradigms mentioned below like the <code class="language-plaintext highlighter-rouge">HttpRequest</code> syntax. The good thing about the following code is you don’t need to create any AWS Layers (zip files of packaged NodeJS files). The <code class="language-plaintext highlighter-rouge">aws-sdk</code> comes for free with Lambda.</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">import</span> <span class="p">{</span> <span class="nx">NodeHttpHandler</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@aws-sdk/node-http-handler</span><span class="dl">"</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">reCaptchaSecret</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">ADDSECRET</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">REGION</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">us-east-1</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">sesClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SESClient</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="nx">REGION</span> <span class="p">});</span>
<span class="k">export</span> <span class="p">{</span> <span class="nx">sesClient</span> <span class="p">};</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="k">async </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Grab the following variable from the User facing form.</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">gRecapResp</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">apiUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URL</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://www.google.com/recaptcha/api/siteverify?secret=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">reCaptchaSecret</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">&amp;response=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">gRecapResp</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpRequest</span><span class="p">({</span>
    <span class="na">hostname</span><span class="p">:</span> <span class="nx">apiUrl</span><span class="p">.</span><span class="nx">hostname</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span>
    <span class="na">protocol</span><span class="p">:</span> <span class="nx">apiUrl</span><span class="p">.</span><span class="nx">protocol</span><span class="p">,</span>
    <span class="na">path</span><span class="p">:</span> <span class="nx">apiUrl</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span>  <span class="nx">apiUrl</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span>
    <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">host</span><span class="dl">"</span><span class="p">:</span> <span class="nx">apiUrl</span><span class="p">.</span><span class="nx">hostname</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span>
    <span class="p">},</span>
  <span class="p">});</span>
  <span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NodeHttpHandler</span><span class="p">();</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">response</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nf">handle</span><span class="p">(</span><span class="k">new</span> <span class="nc">HttpRequest</span><span class="p">(</span><span class="nx">request</span><span class="p">));</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">+</span> <span class="dl">'</span><span class="s1"> </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">statusMessage</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">responseBody</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
  <span class="k">await</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">responseBody</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">responseBody</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">responseBody</span><span class="p">).</span><span class="nx">success</span><span class="p">);</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">responseBody</span><span class="p">).</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SendEmailCommand</span><span class="p">({</span>
          <span class="na">Destination</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">ToAddresses</span><span class="p">:</span> <span class="p">[</span>
              <span class="dl">'</span><span class="s1">test@example.org</span><span class="dl">'</span>
            <span class="p">]</span>
          <span class="p">},</span>
          <span class="na">Message</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">Body</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">Text</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">Data</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Name: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n\n</span><span class="s1">Email: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">mail</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n\n</span><span class="s1">Message: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
                <span class="na">Charset</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UTF-8</span><span class="dl">'</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="na">Subject</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">Data</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">referrer</span> <span class="o">+</span> <span class="dl">'</span><span class="s1"> Website Referral: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
              <span class="na">Charset</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UTF-8</span><span class="dl">'</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="na">Source</span><span class="p">:</span> <span class="dl">'</span><span class="s1">test@example.com</span><span class="dl">'</span>
        <span class="p">});</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">sesClient</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">command</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">callback</span><span class="p">(</span><span class="dl">'</span><span class="s1">MailNotSent</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">finally</span> <span class="p">{</span>
          <span class="nf">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">MailSent</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">callback</span><span class="p">(</span><span class="dl">'</span><span class="s1">MailNotSent</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nf">callback</span><span class="p">(</span><span class="dl">'</span><span class="s1">MailNotSent</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">});</span>

<span class="p">};</span></code></pre></figure> </div> </article> </div> <div id="footer"> <ul class="copyright"> <li>&copy; Parag Magunia or affialiates <img src="/assets/images/flag.svg" height="16px" width="30px" alt="A photo of the United States Flag" class="my_home"></li> <li><a href="/sitemap.xml">Sitemap</a></li> <li><a href="https://pmagunia.com/2017/01/01/credits.html">Credits</a></li> <li><a href="/2017/01/01/privacy.html">Privacy</a></li> <li><a href="/2017/01/01/terms.html">Terms</a></li> <li><a target="_blank" href="https://pagespeed.web.dev/analysis?url=https%3A%2F%2Fpmagunia.com%2F">Page Speed</a></li> </ul> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=G-LNRBXYSVG3"></script> <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LNRBXYSVG3');
</script> </body> </html>